# Схема
Введем несколько систем координат:
1. Инерциальная система координат, связанная с Землей ($Earth$) – $\left(x^e,y^e,z^e\right)$ с началом в точке $O$;
2. неинерциальная система отсчета, связанная с трикоптером (твердым телом $body$) – $\left(x^b,y^b,z^b\right)$ с началом координат в центре масс трикоптера $G$;
3. 3 неинерциальных системы отсчета, связанных с осями вращения винтов (локальные системы координат $local_i$, $i=1,2,3$) – $\left(x^{l^1},y^{l^1},z^{l^1}\right)$, $\left(x^{l^2},y^{l^2},z^{l^2}\right)$, $\left(x^{l^3},y^{l^3},z^{l^3}\right)$ c началами координат в местах приложения сил тяги $O_1,O_2,O_3$.
Все системы координат изображены на рисунке снизу:
![[Source/tricopter.png]]
Для уменьшения влияния реактивных моментов (моментов сил, возникающих вследствие 3-го закона Ньютона: винты "отталкиваются" от воздуха, поэтому воздух их "толкает") 1-й и 2-й винты вращаются в противоположных направлениях:
![[Source/трикоптер сверху.png]]

# Вывод уравнений динамики в базисе $body$
Примем за эмпирические законы следующие выражения, описывающие связь между угловой скоростью вращения винта $\omega_i$ и силой тяги $f_i$, а также реактивным моментом $\tau_i$:
$$f_i=k_t \omega_i^2 \qquad \forall i \in\{1,2,3\},$$$$\tau_i=k_d\omega_i^2\qquad \forall i \in\{1,2,3\},$$
где коэффициенты $k_t$ и $k_d$ ($t$ – *thrust force*, $d$ – *drag torque*) определяются с помощью эксперимента.
Чтобы записать в векторной форме эти силы и моменты сил необходимо знать углы наклона винтов. Конструкция предусматривает повороты вокруг осей $x^{l^i}\quad \forall i \in \{1,2,3\}$, относительно вертикальных осей $z^{l^i} \quad \forall i \in \{1,2,3\}$ соответственно. Обозначим за $\alpha_i$ упомянутые выше углы поворота по направлению правого винта вдоль осей $x^{l^i}\quad \forall i \in \{1,2,3\}$.
Тогда векторы сил тяги, записанные в базисах $local_i$, будут выглядеть следующим образом:
$$\overrightarrow{f_i^{l^i}}=\left[\begin{matrix} 0 \\ -k_t \omega_i^2\sin{\alpha_i} \\ k_t\omega_i^2\cos{\alpha_i} \\ \end{matrix} \right],\quad \alpha_i\in[-\pi/2,\pi/2]\quad\forall i\in\{1,2,3\}.$$
Чтобы получить эти векторы в базисе $body$ требуется построить 3 матрицы перехода от всех локальных базисов $local_i$ к базису $body$.
Для построения таких матриц нужно записать в виде столбцов по очереди базисные векторы нового базиса в старом базисе. Видно, что все локальные базисы повернуты на некоторые углы вокруг оси $z^b$: $\psi_i=\left\{\frac{2\pi}{3},-\frac{2\pi}{3},0\right\}$ соответственно для каждого $i \in \{1,2,3\}$.
Тогда можно сразу записать 3 матрицы перехода, которые будут представлять в данном случае матрицы поворота вокруг оси $z^b$ на различные углы.
Общий вид для матрицы поворота на произвольный угол вокруг этой оси:
$$R_{z^b}=\left[\begin{matrix}\cos{\varphi} & -\sin{\varphi} & 0 \\ \sin{\varphi} & \cos{\varphi} & 0 \\ 0 & 0 & 1 \\ \end{matrix}\right],$$
тогда для 3-х локальных базисов матрицы будут следующие:
$$R_{l_1}^b=\left[\begin{matrix}-\frac{1}{2} & -\frac{\sqrt{3}}{2} & 0 \\ \frac{\sqrt{3}}{2} & -\frac{1}{2} & 0 \\ 0 & 0 & 1 \\ \end{matrix}\right],$$
$$R_{l_2}^b=\left[\begin{matrix}-\frac{1}{2} & \frac{\sqrt{3}}{2} & 0 \\ -\frac{\sqrt{3}}{2} & -\frac{1}{2} & 0 \\ 0 & 0 & 1 \\ \end{matrix}\right],$$
$$R_{l_3}^b=E=\left[\begin{matrix}1&0&0\\0&1&0\\0&0&1\end{matrix}\right].$$
Отсюда можно получить силы тяги в базисе $body$: $\overrightarrow{f_i^b}=R_{l_i}^b\overrightarrow{f_i^{l^i}}\quad\forall i\in\{1,2,3\}$.
$$\overrightarrow{f_1^b}=\left[\begin{matrix} \frac{\sqrt{3}}{2}k_t\omega_1^2\sin{\alpha_1} \\ \frac{1}{2}k_t\omega_1^2\sin{\alpha_1} \\ k_t\omega_1^2\cos{\alpha_1} \\ \end{matrix} \right] = \left[\begin{matrix} \frac{\sqrt{3}}{2}f_1\sin{\alpha_1} \\ \frac{1}{2}f_1\sin{\alpha_1} \\ f_1\cos{\alpha_1} \\ \end{matrix} \right],$$
$$\overrightarrow{f_2^b}=\left[\begin{matrix} -\frac{\sqrt{3}}{2}k_t\omega_2^2\sin{\alpha_2} \\ \frac{1}{2}k_t\omega_2^2\sin{\alpha_2} \\ k_t\omega_2^2\cos{\alpha_2} \\ \end{matrix} \right] = \left[\begin{matrix} -\frac{\sqrt{3}}{2}f_2\sin{\alpha_2} \\ \frac{1}{2}f_2\sin{\alpha_2} \\ f_2\cos{\alpha_2} \\ \end{matrix} \right],$$
$$\overrightarrow{f_3^b}=\overrightarrow{f_3^{l^3}}=\left[\begin{matrix} 0 \\ -k_t \omega_3^2\sin{\alpha_3} \\ k_t\omega_3^2\cos{\alpha_3} \\ \end{matrix} \right]=\left[\begin{matrix} 0 \\ -f_3\sin{\alpha_3} \\ f_3\cos{\alpha_3} \\ \end{matrix} \right].$$
Сложив эти 3 силы, получим суммарную силу, действующую на центр масс $G$, записанную в базисе $body$:
$$\overrightarrow{\mathrm{F}_m^b}=\sum_{i=1}^3{f_i^b}=\left[\begin{matrix}\frac{\sqrt{3}}{2}k_t\omega_1^2\sin{\alpha_1} - \frac{\sqrt{3}}{2}k_t\omega_2^2\sin{\alpha_2} \\ \frac{1}{2}k_t\omega_1^2\sin{\alpha_1} + \frac{1}{2}k_t\omega_2^2\sin{\alpha_2} - k_t \omega_3^2\sin{\alpha_3} \\ k_t\omega_1^2\cos{\alpha_1} + k_t\omega_2^2\cos{\alpha_2} + k_t\omega_3^2\cos{\alpha_3} \\ \end{matrix}\right] =$$
$$=\left[\begin{matrix}\frac{\sqrt{3}}{2} f_1\sin{\alpha_1} - \frac{\sqrt{3}}{2}f_2\sin{\alpha_2} \\ \frac{1}{2}f_1\sin{\alpha_1} + \frac{1}{2}f_2\sin{\alpha_2} - f_3\sin{\alpha_3} \\ f_1\cos{\alpha_1} + f_2\cos{\alpha_2} + f_3\cos{\alpha_3} \\ \end{matrix}\right].$$
Далее будет найден суммарный вектор моментов.
Введем радиус-векторы точек приложения сил $\overrightarrow{f_1}$, $\overrightarrow{f_2}$, $\overrightarrow{f_3}$: $O_1$, $O_2$, $O_3$, из центра масс $G$ – $\vec{r}_{oi}=\left[\begin{matrix}r_{oi_x} & r_{oi_y} & r_{oi_z} \\ \end{matrix}\right]^\top$.
Из рисунка видно, что в базисе $body$ они имеют следующие координаты:
$\vec{r}_{o1}=\left[\begin{matrix}l_2 & -l_1 & 0 \\ \end{matrix}\right]^\top$, $\vec{r}_{o2}=\left[\begin{matrix}l_2 & l_1 & 0 \\ \end{matrix}\right]^\top$, $\vec{r}_{o3}=\left[\begin{matrix}-l_0 & 0 & 0 \\ \end{matrix}\right]^\top$, где $l_1=\frac{\sqrt{3}}{2}l_0$ и $l_2=\frac{1}{2}l_0$, $l_0$ – расстояние от центра масс $G$ до точек приложения сил $O_1$, $O_2$, $O_3$.
Тогда суммарный момент сил, возникающий из-за сил тяги, в базисе $body$ равен
$$\overrightarrow{\mathrm{T}_r^b}=\sum_{i=1}^3{\left[\vec{r}_{oi} \times \overrightarrow{f_i^b}\right]}=\sum_{i=1}^3{\left|\begin{matrix}\vec{i} & \vec{j} & \vec{k} \\ r_{oi_x} & r_{oi_y} & r_{oi_z} \\ f^b_{i_1} & f^b_{i_2} & f^b_{i_3} \\ \end{matrix}\right|}=$$
$$=\left[\begin{matrix}-l_1f_1\cos{\alpha_1} \\ -l_2f_1\cos{\alpha_1} \\ \frac{1}{2}l_2f_1\sin{\alpha_1}+\frac{\sqrt{3}}{2}l_1f_1\sin{\alpha_1} \\\end{matrix}\right] + \left[\begin{matrix}l_1f_2\cos{\alpha_2} \\ -l_2f_2\cos{\alpha_2} \\ \frac{1}{2}l_2f_2\sin{\alpha_2}+\frac{\sqrt{3}}{2}l_1f_2\sin{\alpha_2}\end{matrix}\right] +$$
$$+\left[\begin{matrix}0 \\ l_0f_3\cos{\alpha_3} \\ l_0f_3\sin{\alpha_3}\end{matrix}\right]=\left[\begin{matrix}\frac{\sqrt{3}}{2}l_0f_2\cos{\alpha_2}-\frac{\sqrt{3}}{2}l_0f_1\cos{\alpha_1} \\ l_0f_3\cos{\alpha_3}-\frac{1}{2}l_0f_1\cos{\alpha_1}-\frac{1}{2}l_0f_2\cos{\alpha_2} \\ l_0f_1\sin{\alpha_1}+l_0f_2\sin{\alpha_2}+l_0f_3\sin{\alpha_3}\end{matrix}\right].$$
Каждый винт в силу 3-го закона Ньютона создает реактивный момент сил, направленный против его угловой скорости вращения. В локальных базисах $local_i$ они запишутся так:
$$\overrightarrow{\tau_{d,i}^{l^i}}=\pm \left[\begin{matrix} 0 \\ k_d\omega_i^2\sin{\alpha_i} \\ -k_d\omega_i^2\cos{\alpha_i} \\ \end{matrix}\right] \qquad \forall i \in \{1,2,3\},$$
где "$+$" ставится, если $\overrightarrow{\omega_i} \uparrow\uparrow \overrightarrow{f_i^{l^i}}$, и "$-$", если $\overrightarrow{\omega_i} \uparrow\downarrow \overrightarrow{f_i^{l^i}}$.
Тогда, если положить, что 1-й и 3-й винты вращаются по направлению правого винта (против часовой стрелки), а 2-й – по направлению левого винта (по часовой стрелке), то суммарный реактивный момент в базисе $body$ будет равен
$$\overrightarrow{\mathrm{T}_d^b}=\sum_{i=1}^3{(R_{l_i}^b \cdot\overrightarrow{\tau_{d,i}^{l^i}})}=\left[\begin{matrix}-\frac{\sqrt{3}}{2}\tau_1\sin{\alpha_1} \\ -\frac{1}{2}\tau_1\sin{\alpha_1} \\ -\tau_1\cos{\alpha_1}\end{matrix}\right] + \left[\begin{matrix}-\frac{\sqrt{3}}{2}\tau_2\sin{\alpha_2} \\ \frac{1}{2}\tau_2\sin{\alpha_2} \\ \tau_2\cos{\alpha_2}\end{matrix}\right] + \left[\begin{matrix}0 \\ \tau_3\sin{\alpha_3} \\ -\tau_3\cos{\alpha_3}\end{matrix}\right] = $$
$$=\left[\begin{matrix}-\frac{\sqrt{3}}{2}\tau_1\sin{\alpha_1}-\frac{\sqrt{3}}{2}\tau_2\sin{\alpha_2} \\ -\frac{1}{2}\tau_1\sin{\alpha_1}+\frac{1}{2}\tau_2\sin{\alpha_2}+\tau_3\sin{\alpha_3} \\ -\tau_1\cos{\alpha_1}+\tau_2\cos{\alpha_2}-\tau_3\cos{\alpha_3} \\\end{matrix}\right].$$
Тогда суммарный момент сил в базисе $body$ равен
$$\overrightarrow{\mathrm{T}_m^b}=\overrightarrow{\mathrm{T}_r^b}+\overrightarrow{\mathrm{T}_d^b}=$$
$$=\left[\begin{matrix}\frac{\sqrt{3}}{2}l_0f_2\cos{\alpha_2}-\frac{\sqrt{3}}{2}l_0f_1\cos{\alpha_1} -\frac{\sqrt{3}}{2}\tau_1\sin{\alpha_1}-\frac{\sqrt{3}}{2}\tau_2\sin{\alpha_2}  \\ l_0f_3\cos{\alpha_3}-\frac{1}{2}l_0f_1\cos{\alpha_1}-\frac{1}{2}l_0f_2\cos{\alpha_2} -\frac{1}{2}\tau_1\sin{\alpha_1}+\frac{1}{2}\tau_2\sin{\alpha_2}+\tau_3\sin{\alpha_3} \\ l_0f_1\sin{\alpha_1}+l_0f_2\sin{\alpha_2}+l_0f_3\sin{\alpha_3} -\tau_1\cos{\alpha_1}+\tau_2\cos{\alpha_2}-\tau_3\cos{\alpha_3}  \\\end{matrix}\right].$$
В итоге связь между суммарными силой и моментом сил, действующими на трикоптер, может быть выражена следующим образом:
$$\mathrm{U=M\Omega},$$
где $\mathrm{U}=\left[\begin{matrix}\overrightarrow{\mathrm{F}_m^b} \\ \overrightarrow{\mathrm{T}_m^b} \\ \end{matrix} \right]$ и
$$\mathrm{M}=\left[\begin{matrix}\frac{\sqrt{3}}{2}k_t & -\frac{\sqrt{3}}{2}k_t & 0 & 0& 0 & 0 \\ 
\frac{1}{2}k_t & \frac{1}{2}k_t & -k_t & 0 & 0 & 0 \\
0& 0& 0 & k_t & k_t & k_t \\
-\frac{\sqrt{3}}{2}k_d &-\frac{\sqrt{3}}{2}k_d & 0 & -\frac{\sqrt{3}}{2}l_0k_t & \frac{\sqrt{3}}{2}l_0k_t & 0 \\
-\frac{1}{2}k_d & \frac{1}{2}k_d & k_d & -\frac{1}{2}l_0k_t & -\frac{1}{2}l_0k_t & l_0k_t \\
l_0k_t & l_0k_t & l_0k_t & -k_d & k_d & -k_d \\
\end{matrix}\right], \quad \mathrm{\Omega}=\left[\begin{matrix}\omega_1^2\sin{\alpha_1} \\ \omega_2^2\sin{\alpha_2} \\ \omega_3^2\sin{\alpha_3} \\ \omega_1^2\cos{\alpha_1} \\ \omega_2^2\cos{\alpha_2} \\ \omega_3^2\cos{\alpha_3}\end{matrix}\right].$$
$\det(\mathrm{M}) \neq 0$ при $k_t,k_d,l_0>0\quad \Rightarrow$    формула выше – взаимнооднозначное соответствие.

# Применение кватернионов к рекуррентному способу описания ориентации трикоптера
Перед любым полетом трикоптер необходимо откалибровать – как минимум, чтобы он знал, где земля. Для этого он оставляется в неподвижном состоянии, после чего внутренним трехосевым акселерометром измеряется модуль и направление вектора ускорения свободного падения. Очевидно, оно должно быть направлено вниз, поэтому из этой информации можно найти ось и угол наклона дрона, при котором его акселерометр показал бы это ускорение именно таким образом. Этот поворот закладывается в кватернион $\Lambda(0)$ по принципу, описанном в приложении про кватернионы.
Далее используется уравнение Пуассона, позволяющее отслеживать ориентацию трикоптера на основании старой ориентации и угловой скорости, записанной в базисе $body$:
Сначала вычисляется производная кватерниона $\Lambda$
$$\dot{\Lambda}(t)=\frac{1}{2}\Lambda(t)\circ\vec{\omega}^b(t),$$
а затем получается новый кватернион по следующей формуле:
$$\Lambda(t+\Delta t)=\Lambda(t)+\dot{\Lambda}(t)\Delta t.$$
Для произведения таких вычислений требуется наличие $\Lambda(t),\Delta t, \vec{\omega}^b(t)$. Последняя величина так же, как и $\Lambda(t)$, передается в новую итерацию из старой.
Для определения мгновенного вектора угловой скорости $\vec{\omega}^b$ можно воспользоваться зависимостью ниже:
$$\vec{L}^b(t)=\widetilde{J}\cdot\vec{\omega}^b(t),$$
где $\vec{L}^b(t)$ – момент импульса в базисе $body$, а $\widetilde{J}$ – тензор инерции трикоптера в этом же базисе (далее будем предполагать, что мы его знаем, он вычисляется либо программой на основе высокоточного моделирования, либо измеряется для конкретного собранного летательного аппарата).
Чтобы найти момент импульса, нужно численно решить следующее дифференциальное уравнение:
$$\frac{d\vec{L}^b}{dt}(t)=\overrightarrow{\mathrm{T}_m^b}(t),$$
$$\left.\frac{\Delta \vec{L}^b(t)}{\Delta t}=\widetilde{J}\cdot\frac{\Delta \vec{\omega}^b(t)}{\Delta t}=\overrightarrow{\mathrm{T}_m^b}(t), \quad \Delta t \rightarrow 0,\qquad \right|\widetilde{J}^{-1}\Delta t\cdot$$
$$\Delta \vec{\omega}^b(t)=\Delta t\cdot\widetilde{J}^{-1} \overrightarrow{\mathrm{T}_m^b}(t),$$
Тогда угловую скорость в следующий момент времени можно записать в виде
$$\vec{\omega}^b(t+\Delta t)=\vec{\omega}^b(t)+\Delta t\cdot\widetilde{J}^{-1} \overrightarrow{\mathrm{T}_m^b}(t).$$
Как уже было сказано выше, это значение пойдет в следующую итерацию наряду с вычисленным сразу после него $\Lambda(t+\Delta t)$.
Однако использоваться в чистом виде эта угловая скорость в системе управления не будет. Из нее и из данных от гироскопа (гироскоп дает свой вектор угловой скорости $\vec{\omega}_{meas}$) будет получена оценка с помощью фильтра Калмана: для фазы предсказания $predict$ будет использоваться $\vec{\omega}^b(t)$, а для фазы уточнения с помощью измерений $update$ – $\vec{\omega}_{meas}$.

# Получение силы тяги $\overrightarrow{\mathrm{F}_m^b}$ в базисе $Earth$
Так как теперь в любой момент времени имеется ориентация летательного аппарата, заданная кватернионом $\Lambda(t)$, можно воспользоваться теоремой о повороте векторов и получить вектор силы тяги $\overrightarrow{\mathrm{F}_m^e}$.
$$\overrightarrow{\mathrm{F}_m^e}(t)=\Lambda(t) \circ \overrightarrow{\mathrm{F}_m^b}(t)\circ\widetilde{\Lambda}(t).$$
# Корректировка показаний трехосевого акселерометра
Чтобы обладать более менее корректной информацией о состоянии трикоптера, необходимо соединить предсказательную теоретическую модель с измерениями с помощью фильтра Калмана.
Как именно это будет реализовано, будет рассмотрено позже, а сейчас будет разобран принцип исключения ускорения Кориолиса из показаний акселерометра (при приближении, что акселерометр находится в центре масс $G$).
![[Source/Акселерометр.png]]
Акселерометр делает измерения внутри подвижного базиса $body$, причем можно считать, что он как бы *наблюдает* за небольшой массой $m$ на пружинном подвесе, т.е. для простоты рассуждений будем считать, что никаких пружин нет, а акселерометр действительно смотрит за движением этого кусочка массы на любые расстояния, хотя в действительности пружины удерживают его в закрытой коробочке. Тогда можно положить, что скорость в абсолютной инерциальной системе координат, связанной с Землей ($Earth$), его скорость будет равна 0: $\vec{v}_a=0$, ровно как и ускорение: $\overrightarrow{W}_a^e=0$.
Пользуясь теоремой Кориолиса о сложении ускорений, получим
$$\overrightarrow{W}_a^e=\overrightarrow{W}_e^e+\overrightarrow{W}_r^e+\overrightarrow{W}_c^e=0,$$
где $\overrightarrow{W}_e^e$ – переносное ускорение, т.е. ускорение неподвижной относительно $body$ точки пространства (это и есть то ускорение, которое требуется получить), $-\overrightarrow{W}_r^e$ – показания акселерометров (эти датчики автоматически умножают ускорение массы $m$ на "$-$", потому что если $m$ ускоряется в 1-м направлении, то трикоптер ускоряется в противоположном), $\overrightarrow{W}_c^e=2\cdot\vec{\omega}^e \times \vec{v}_r^e$ – ускорение Кориолиса, причем $\vec{\omega}^e$ – мгновенная угловая скорость базиса $body$, а $\vec{v}_r^e$ – скорость $m$ относительно $body$ ($\vec{v}_r^e=-\vec{v}_e^e=-\overrightarrow{v_m^e}$ по теореме о сложении скоростей, т.к. $\vec{v}_a^e=\vec{v}_e^e+\vec{v}_r^e=0$, а переносная скорость $\vec{v}_e^e$ для $body$ совпадает со скоростью трикоптера (вернее, оценкой скорости) $\widehat{\vec{v}_m^e}$ в базисе $Earth$).
Из уравнения выше получается
$$\overrightarrow{W}_e^e=\underbrace{-\overrightarrow{W}_r^e}_{\text{акселерометр}}-\underbrace{\overrightarrow{W}_c^e}_{-2\cdot\widehat{\vec{\omega}^e}\times \widehat{\vec{v}_m^e}}.$$
Т.е. финальная формула будет следующей:
$$\overrightarrow{W}_e^e=\underbrace{-\overrightarrow{W}_r^e}_{\text{акселерометр}}+2\cdot\widehat{\vec{\omega}^e}\times \widehat{\vec{v}_m^e},$$
причем все векторы должны быть переведены в базис $Earth$ (через кватернион $\Lambda$)!
# Схема САУ
![[Source/Структурная_схема_САУ_трикоптера.svg]]
#Робототехника 